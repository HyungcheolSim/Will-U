<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="/css/profile.css">
  
    <script src="https://cdn.jsdelivr.net/npm/js-cookie@3.0.5/dist/js.cookie.min.js"></script>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
            integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
            crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.min.js"
            integrity="sha384-Rx+T1VzGupg4BHQYs2gCW9It+akI2MM/mndMCy36UVfodzcJcF0GGLxZIzObiEfa"
            crossorigin="anonymous"></script>
    
    <th:block th:replace="~{fragments/sidebar::common-header}"></th:block>
  
    <title>프로필 페이지</title>
</head>
<body>
<div id="sideBarDiv" th:insert="~{fragments/sidebar::sidebarFragment}"></div>
<div class="profile-container">
    <img th:src="${user.picture}" alt="Profile Image" width="70" height="70 style=" src="">
    <a th:text="${user.nickname}" class="navbar-brand nickname"> Nickname </a>

    <div class="evaluation">
        <h2>점수 : <span th:text="${userScore}"></span></h2>
    </div>

    <div class="receiveReviews">
        <h2>받은 후기</h2>
        <div class="review-tab tab-content" id="receive-reviews">
            <ul class="review-list">
                <li th:each="review : ${receiveReviews}">
                <span th:text="${review.content + '평점: ' + review.score +
                ' 작성자: ' + review.senderNickname}"
                      th:attr="data-user-id=${review.senderId}"
                      class="review"></span>
                </li>
            </ul>
        </div>
    </div>
    <div class="sendReviews">
        <h2>작성한 후기</h2>
        <div class="review-tab tab-content" id="sand-reviews">
            <ul class="review-list">
                <li th:each="review : ${sendReviews}">
                <span th:text="${review.content + ' 받은 유저: ' + review.receiverNickname}"
                      th:attr="data-user-id=${review.receiverId}"
                      class="review"></span>
                </li>
            </ul>
        </div>
    </div>
    <button type="button" id="edit-profile-button" class="btn btn-primary">프로필 수정</button>
</div>
<div id="edit-profile-modal" class="modal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">프로필 수정</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="edit-image-form" enctype="multipart/form-data">
                    <div class="form-group">
                        <label for="profile-image">프로필 이미지 업로드:</label>
                        <input type="file" id="profile-image" accept="image/*" class="form-control-file">
                    </div>
                    <button type="submit" class="btn btn-primary">저장</button>
                </form>
                <form id="edit-nickname-form">
                    <div class="form-group">
                        <label for="nickname">새로운 닉네임:</label>
                        <input type="text" id="nickname" name="nickname" class="form-control">
                    </div>
                    <button type="submit" class="btn btn-primary">저장</button>
                </form>
            </div>
        </div>
    </div>
</div>
<script>
    const editProfileButton = document.getElementById("edit-profile-button");
    const editProfileModal = document.getElementById("edit-profile-modal");
    const closeModal = document.querySelector(".close");

    editProfileButton.addEventListener("click", () => {
        editProfileModal.style.display = "block";
    });

    closeModal.addEventListener("click", () => {
        editProfileModal.style.display = "none";
    });

    window.addEventListener("click", event => {
        if (event.target === editProfileModal) {
            editProfileModal.style.display = "none";
        }
    });

    const editProfileForm = document.getElementById("edit-nickname-form");

    editProfileForm.addEventListener("submit", async event => {
        event.preventDefault();

        const newNickname = editProfileForm.nickname.value;

        try {
            const response = await fetch("/api/users", {
                method: "PUT",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    nickname: newNickname
                })
            });

            if (response.ok) {
                // 성공적으로 수정되었을 때의 처리
                // 예: 모달 닫기 등
                editProfileModal.style.display = "none";
                window.alert("닉네임이 성공적으로 수정되었습니다.");
                location.reload();
            } else {
                // 서버로부터 실패 응답을 받았을 때의 처리
                // 예: 에러 메시지 표시 등
                console.error("프로필 수정 실패");
                window.alert("닉네임 수정이 실패했습니다.");

            }
        } catch (error) {
            // API 요청 중에 발생한 오류 처리
            console.error("API 요청 오류:", error);
        }
    });

    const editImageForm = document.getElementById("edit-image-form");
    const profileImageInput = document.getElementById("profile-image");

    editImageForm.addEventListener("submit", async event => {
        event.preventDefault();

        const formData = new FormData();
        formData.append("file", profileImageInput.files[0]);

        try {
            const response = await fetch("/api/image", {
                method: "POST",
                body: formData
            });

            if (response.ok) {
                // 이미지 업로드 성공 시의 처리
                // 예: 프로필 이미지를 업데이트하고 모달 닫기 등
                editProfileModal.style.display = "none";
                // window.alert("프로필 이미지가 성공적으로 업로드되었습니다.");
                location.reload();
            } else {
                // 이미지 업로드 실패 시의 처리
                // 예: 에러 메시지 표시 등
                console.error("프로필 이미지 업로드 실패");
                window.alert("프로필 이미지 업로드가 실패했습니다.");
            }
        } catch (error) {
            // API 요청 중에 발생한 오류 처리
            console.error("API 요청 오류:", error);
        }
    });

    const interestUsers = document.querySelectorAll('.review');
    interestUsers.forEach(user => {
        user.addEventListener('click', function (event) {
            const userId = event.target.getAttribute('data-user-id');
            window.location.href = `/users/profile/${userId}`; // 적절한 URL로 변경해야 함
        });
    });
</script>
</body>
</html>
